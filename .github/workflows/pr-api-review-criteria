name: PR build workflow

on: 
  pull_request:
    branches: [main]
    paths:
      - apis/**
  workflow_dispatch:

permissions:
  checks: write

jobs:
  pr-api-minium-review-criteria:
    name: Minimum API design reivew criteria
    runs-on: ubuntu-latest
    steps:
      - name: Checkout out pr branch
        uses: actions/checkout@v3
        with:
          path: revision
      - name: View working folder
        run:  tree
      - name: Check PR title
        run: ./pr-title.sh ${{ github.event.pull_request.title }}
      - name: Run API linting
        run: | 
          npx @stoplight/spectral-cli lint "./revision/chapter8/apis/product-catalog.oas.yaml" --ruleset "./revision/chapter8/apis/rulesets/json-api.ruleset.yaml"
      - name: Check out main branch
        uses: actions/checkout@v3
        with:
          ref: main
          path: base
      - name: View working folder
        run: |
          ls -lash
          ls -lash revision
      - name: Breaking change checks
        id: test_breaking_changes
        uses: oasdiff/oasdiff-action/check-breaking@main
        with:
          base: './base/chapter8/apis/product-catalog.oas.yaml'
          revision: './revision/chapter8/apis/product-catalog.oas.yaml'
          fail-on-diff: true
      - name: Prose Linting
        run: | 
          wget -nv  https://github.com/errata-ai/vale/releases/download/v2.15.4/vale_2.15.4_Linux_64-bit.tar.gz
          mkdir bin && tar -xvzf vale_2.15.4_Linux_64-bit.tar.gz -C bin
          export PATH=./bin:"$PATH"
          vale --config=revision/.vale.ini revision/chapter8/apis/docs
